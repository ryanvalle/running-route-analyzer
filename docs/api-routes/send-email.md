# POST /api/send-email

## Overview
Sends a formatted HTML email report containing route analysis, maps, and elevation charts.

## File Location
`app/api/send-email/route.ts`

## Request

### Method
`POST`

### Headers
```
Content-Type: application/json
```

### Body Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `email` | `string` | Yes | Recipient email address |
| `analysis` | `RouteAnalysis` | Yes | Complete route analysis object |
| `mapImage` | `string` | Yes | Base64-encoded PNG map image |
| `chartImage` | `string` | Yes | Base64-encoded PNG chart image |

### Example Request
```json
{
  "email": "runner@example.com",
  "analysis": {
    "totalDistance": 5.23,
    "totalElevationGain": 450,
    "totalElevationLoss": 420,
    "segments": [...],
    "summary": "The first 3 miles...",
    "unit": "miles",
    "increment": 1
  },
  "mapImage": "data:image/png;base64,iVBORw0KGgo...",
  "chartImage": "data:image/png;base64,iVBORw0KGgo..."
}
```

## Response

### Success Response (200 OK)
```json
{
  "success": true,
  "message": "Email sent successfully",
  "emailId": "abc123-def456-ghi789"
}
```

### Error Responses

**400 Bad Request** - Invalid email
```json
{
  "error": "Valid email address is required"
}
```

**500 Internal Server Error** - Not configured
```json
{
  "error": "Email service not configured. Please add RESEND_API_KEY to environment variables.",
  "instructions": "Get a free API key at https://resend.com"
}
```

**500 Internal Server Error** - Send failure
```json
{
  "error": "Failed to send email",
  "details": "Error message from Resend"
}
```

## Dependencies

### Environment Variables
- `RESEND_API_KEY` (required) - Resend API key

### External Dependencies
```typescript
import { Resend } from 'resend';
```

### Internal Dependencies
```typescript
import { RouteAnalysis } from '@/types';
```

## Email Content

### Subject Line
```
Route Analysis - {distance} {unit}
```
Example: "Route Analysis - 5.23 mi"

### HTML Template
Generated by `generateEmailHTML()` function with sections:
1. Header with title
2. Route summary box
3. AI coaching insights (if available)
4. Overall stats grid
5. Elevation chart image
6. Route map image
7. Mile-by-mile table
8. Footer

See [Resend Integration](../third-party/resend.md) for detailed template.

## Validation

### Email Validation
```typescript
if (!email || !email.includes('@')) {
  return error;
}
```

Consider adding regex for production:
```typescript
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
```

### Image Validation
Logged for debugging (not blocking):
```typescript
console.log('Map image length:', mapImage?.length || 0);
console.log('Chart image starts with data:image/png:', mapImage?.startsWith('data:image/png'));
```

## Testing

### Manual Testing
```bash
curl -X POST http://localhost:3000/api/send-email \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "analysis": {...},
    "mapImage": "data:image/png;base64,...",
    "chartImage": "data:image/png;base64,..."
  }'
```

## Related Documentation

- [Resend Integration](../third-party/resend.md)
- [EmailReport Component](../components/EmailReport.md)
