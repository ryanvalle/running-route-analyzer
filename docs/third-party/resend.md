# Resend Email API Integration

## Overview

The Running Route Analyzer uses Resend to send beautifully formatted HTML email reports containing route analysis, maps, and elevation charts. Resend provides a reliable, developer-friendly email API with a generous free tier.

## Setup Steps

### 1. Create a Resend Account

1. Visit [Resend.com](https://resend.com)
2. Sign up for a free account
3. Verify your email address

**Free Tier:**
- 100 emails per day
- 3,000 emails per month
- Perfect for personal use and small applications

### 2. Generate API Key

1. Log in to [Resend Dashboard](https://resend.com/home)
2. Navigate to "API Keys" section
3. Click "Create API Key"
4. Give it a name (e.g., "Route Analyzer")
5. Select permissions: "Sending access"
6. Copy the API key (starts with `re_`)

### 3. Configure Environment Variable

Add the following to your `.env.local` file:

```bash
RESEND_API_KEY=re_...your_key_here
```

**Production Deployment:**
Add the same environment variable to your hosting platform (e.g., Vercel project settings).

### 4. (Optional) Configure Custom Domain

For production use with custom sender domain:

1. Go to "Domains" in Resend dashboard
2. Add your domain
3. Add DNS records (SPF, DKIM, etc.)
4. Verify domain
5. Update `from` address in code

**Note:** Free tier allows sending from `onboarding@resend.dev` (used by default).

## Email Integration

### API Route: `/api/send-email` (POST)
**File:** `app/api/send-email/route.ts`

**Purpose:** Send route analysis report via email

**Request Body:**
```typescript
{
  email: string;              // Recipient email address
  analysis: RouteAnalysis;    // Full analysis object
  mapImage: string;           // Base64-encoded map image (data:image/png)
  chartImage: string;         // Base64-encoded chart image (data:image/png)
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Email sent successfully",
  "emailId": "abc123..."
}
```

**Response (Error):**
```json
{
  "error": "Failed to send email",
  "details": "Error message..."
}
```

**Dependencies:**
- Environment: `RESEND_API_KEY` (required)
- Package: `resend` npm package
- Types: `RouteAnalysis` from `@/types`

### Resend SDK Usage

**Initialization:**
```typescript
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);
```

**Sending Email:**
```typescript
const { data, error } = await resend.emails.send({
  from: 'Route Analyzer <onboarding@resend.dev>',
  to: [email],
  subject: `Route Analysis - ${analysis.totalDistance.toFixed(2)} ${unitLabel}`,
  html: htmlContent,
});
```

## Email Template

### HTML Email Structure

**Generated by:** `generateEmailHTML()` function in `app/api/send-email/route.ts`

**Sections:**
1. **Header**: Title and description
2. **Route Summary**: Natural language overview
3. **AI Coaching Insights**: Personalized recommendations (if available)
4. **Overall Stats**: Distance, elevation gain/loss cards
5. **Elevation Chart**: Embedded image
6. **Route Map**: Embedded image
7. **Mile-by-Mile Breakdown**: Detailed table
8. **Footer**: Branding and attribution

**Styling:**
- Inline CSS for email client compatibility
- Responsive design
- Dark mode not supported in email (uses light theme)
- Maximum width: 800px

### Example Email HTML

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Route Analysis</title>
</head>
<body style="font-family: -apple-system, ...; background-color: #f9fafb;">
  <div style="max-width: 800px; margin: 0 auto; background-color: #ffffff; padding: 32px;">
    
    <!-- Header -->
    <div style="text-align: center; margin-bottom: 32px;">
      <h1 style="font-size: 32px; font-weight: bold;">
        Route Analysis Report
      </h1>
      <p style="font-size: 16px; color: #6b7280;">
        Detailed elevation profile and terrain breakdown
      </p>
    </div>

    <!-- Summary Section -->
    <div style="background-color: #eff6ff; border-left: 4px solid #3b82f6; ...">
      <h2>Route Summary</h2>
      <p>The first 3 miles will be relatively flat. Expect elevation gain starting at mile 4.</p>
    </div>

    <!-- AI Insights (if available) -->
    <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e0e7ff 100%); ...">
      <h2>AI Coaching Insights</h2>
      <div>[AI generated HTML content]</div>
    </div>

    <!-- Stats Grid -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); ...">
      <div>Distance: 5.00 mi</div>
      <div>Gain: +450 ft</div>
      <div>Loss: -420 ft</div>
    </div>

    <!-- Chart Image -->
    <img src="data:image/png;base64,..." alt="Elevation Chart" />

    <!-- Map Image -->
    <img src="data:image/png;base64,..." alt="Route Map" />

    <!-- Table -->
    <table>[Mile-by-mile breakdown]</table>

    <!-- Footer -->
    <div>Generated by Route Analyzer</div>
  </div>
</body>
</html>
```

### Dynamic Content

**Subject Line:**
```typescript
`Route Analysis - ${analysis.totalDistance.toFixed(2)} ${unitLabel}`
```
Example: "Route Analysis - 5.23 mi"

**Segment Table:**
- Dynamic rows based on segments
- Color-coded grades (green=uphill, red=downhill, gray=flat)
- Formatted elevation gains/losses
- Mile or kilometer labels based on unit setting

**Conditional Sections:**
- AI insights only shown if `analysis.aiCoachingInsights` exists
- Chart image only shown if `chartImage` provided
- Map image only shown if `mapImage` provided

## Image Handling

### Image Capture

**Map Image:**
- Captured using `leaflet-image` library
- Component: `RouteMap.tsx`
- Function: `captureMapImage()`
- Format: PNG
- Resolution: Matches visible map size

**Chart Image:**
- Captured using `html2canvas` library
- Component: `ElevationChart.tsx`
- Function: `captureChartImage()`
- Format: PNG
- Resolution: Higher than visible (2x scale factor)

### Base64 Encoding

Images are converted to base64 data URLs:
```
data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...
```

**Advantages:**
- Embedded directly in HTML
- No external image hosting needed
- Reliable delivery across email clients

**Limitations:**
- Increases email size
- Some email clients may not support large data URLs
- Typical size: 100-500 KB per email

### Image Validation

```typescript
// Validate images before sending
console.log('Map image length:', mapImage?.length || 0);
console.log('Chart image length:', chartImage?.length || 0);
console.log('Map starts with data:image/png:', mapImage?.startsWith('data:image/png'));
console.log('Chart starts with data:image/png:', chartImage?.startsWith('data:image/png'));
```

## Component Integration

### EmailReport Component
**File:** `components/EmailReport.tsx`

**Purpose:** Dialog for email report functionality

**Features:**
- Email address input with validation
- Capture map and chart as images
- Send request to `/api/send-email`
- Loading and success states
- Error handling

**Flow:**
1. User clicks "Email Report" button
2. Dialog opens with email input
3. User enters email and clicks "Send"
4. Component captures map image
5. Component captures chart image
6. Component sends POST to `/api/send-email`
7. Success message or error shown

**Dependencies:**
- `RouteAnalysisDisplay` (parent component with refs)
- `html2canvas` for chart capture
- `leaflet-image` for map capture (via RouteMap)

### Capture Functions

**Chart Capture:**
```typescript
const chartContainer = chartContainerRef.current;
if (!chartContainer) return;

const canvas = await html2canvas(chartContainer, {
  backgroundColor: '#ffffff',
  scale: 2,
  logging: false,
});

const chartImage = canvas.toDataURL('image/png');
```

**Map Capture:**
```typescript
// In RouteMap component
const captureMap = () => {
  return new Promise((resolve) => {
    leafletImage(mapRef.current, (err, canvas) => {
      if (err) {
        console.error('Error capturing map:', err);
        resolve(null);
        return;
      }
      resolve(canvas.toDataURL('image/png'));
    });
  });
};
```

## Email Validation

### Client-Side Validation

**Basic check:**
```typescript
if (!email || !email.includes('@')) {
  return NextResponse.json(
    { error: 'Valid email address is required' },
    { status: 400 }
  );
}
```

**Enhanced validation:**
Consider adding regex pattern:
```typescript
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
if (!emailRegex.test(email)) {
  return { error: 'Invalid email format' };
}
```

## Error Handling

### API Not Configured

```typescript
if (!process.env.RESEND_API_KEY) {
  return NextResponse.json(
    { 
      error: 'Email service not configured. Please add RESEND_API_KEY to environment variables.',
      instructions: 'Get a free API key at https://resend.com'
    },
    { status: 500 }
  );
}
```

**User sees:** Helpful error message with setup instructions

### Send Failure

```typescript
if (sendError) {
  throw new Error(sendError.message || 'Failed to send email via Resend');
}

catch (error) {
  console.error('Error sending email:', error);
  return NextResponse.json(
    { 
      error: 'Failed to send email',
      details: error instanceof Error ? error.message : 'Unknown error'
    },
    { status: 500 }
  );
}
```

### Common Error Messages

**"Email service not configured"**
- Missing `RESEND_API_KEY`
- Solution: Add API key to environment variables

**"Invalid email address"**
- Email validation failed
- Solution: Enter valid email format

**"Failed to send email via Resend"**
- Resend API error
- Check API key validity
- Check Resend account status
- Check rate limits

## Rate Limits

### Resend Free Tier Limits

- **100 emails per day**
- **3,000 emails per month**
- Enough for personal use and demos

### Upgrade Options

**Pro Plan ($20/month):**
- 50,000 emails/month
- Custom domains
- Team access
- Priority support

## Email Client Compatibility

### Tested Clients

The email template works with:
- ✅ Gmail (web, mobile)
- ✅ Apple Mail (macOS, iOS)
- ✅ Outlook (web, desktop)
- ✅ Yahoo Mail
- ✅ Thunderbird

### Known Limitations

- Dark mode not supported (emails always use light theme)
- Some email clients may not support grid layout (falls back to stacked)
- Base64 images work in most clients but may be blocked by security settings

## Security Considerations

### Input Validation

- Email address validated before sending
- Analysis data validated (RouteAnalysis type)
- Images validated (base64 format)

### API Key Protection

- Stored in environment variables
- Never exposed to client
- Only used server-side

### Spam Prevention

- Rate limits via Resend
- Sent from verified domain (onboarding@resend.dev)
- Proper email headers (SPF, DKIM)

## Testing

### Manual Testing Checklist

- [ ] Email sent successfully to personal email
- [ ] Email contains all sections (summary, stats, images, table)
- [ ] Map image displays correctly
- [ ] Chart image displays correctly
- [ ] AI insights included (if configured)
- [ ] Subject line correct
- [ ] Table formatting correct
- [ ] Email received within 1 minute
- [ ] Test with Gmail, Outlook, Apple Mail
- [ ] Test error handling (invalid email, missing API key)

### Unit Tests

Currently no unit tests exist. Consider adding:
- Email validation tests
- HTML generation tests
- Error handling tests

### Integration Tests

Consider adding:
- Mock Resend API
- Test email generation with various route profiles
- Test image embedding

## Troubleshooting

### Email Not Received

**Check spam folder:**
- Emails from `onboarding@resend.dev` may be flagged
- Mark as "Not Spam" to whitelist

**Verify email address:**
- Check for typos
- Ensure valid format

**Check Resend dashboard:**
- Log in to Resend
- Check "Emails" section for delivery status
- Look for bounce or failed status

### Images Not Displaying

**Check console logs:**
```
Email API received images:
- Map image length: 12345
- Chart image length: 23456
- Map starts with data:image/png: true
- Chart starts with data:image/png: true
```

**Email client settings:**
- Some clients block external images by default
- Click "Display images" or "Show images"

### Rate Limit Exceeded

**Error:** "Daily limit exceeded"

**Solutions:**
- Wait until next day (UTC reset)
- Upgrade to Pro plan
- Implement request throttling

## Custom Domain Setup

### Add Domain to Resend

1. Go to "Domains" in Resend dashboard
2. Click "Add Domain"
3. Enter your domain (e.g., `yourdomain.com`)
4. Add DNS records:

```
Type  Host            Value
TXT   @               [Verification code]
TXT   resend._domainkey  [DKIM key]
TXT   @               v=spf1 include:resend.com ~all
```

5. Verify domain
6. Update `from` address in code:

```typescript
from: 'Route Analyzer <noreply@yourdomain.com>',
```

### Benefits

- Professional sender address
- Better deliverability
- Brand consistency
- Lower spam score

## Additional Resources

- [Resend Documentation](https://resend.com/docs)
- [Resend Dashboard](https://resend.com/home)
- [Email Best Practices](https://resend.com/docs/send-with-nodejs)
- [Domain Setup Guide](https://resend.com/docs/dashboard/domains/introduction)
- [API Reference](https://resend.com/docs/api-reference/emails/send-email)

## Related Documentation

- [Overview](../overview.md) - Application overview
- [API Routes](../api-routes/send-email.md) - Send email endpoint
- [Components](../components/EmailReport.md) - EmailReport component
